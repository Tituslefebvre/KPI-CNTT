{% extends "base.html" %}

{% block title %}Chỉnh sửa Đánh giá - Hệ thống KPI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2><i class="bi bi-pencil-square"></i> Chỉnh sửa Đánh giá</h2>
    </div>
</div>

<form method="POST" action="{{ url_for('evaluation.edit', id=evaluation.id) }}">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Thông tin đánh giá</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Viên chức:</strong> {{ evaluation.staff.user.full_name }}</p>
                    <p><strong>Kỳ đánh giá:</strong> {{ evaluation.period.name }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Trạng thái:</strong> 
                        {% if evaluation.status == 'draft' %}
                        <span class="badge bg-secondary">Nháp</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Nhập dữ liệu đánh giá</h5>
        </div>
        <div class="card-body">
            {% if evaluation.details %}
                {% for detail in evaluation.details %}
                <div class="border p-3 mb-3">
                    <h6 class="text-primary">
                        {{ detail.indicator.code }} - {{ detail.indicator.name }}
                    </h6>
                    <p class="text-muted mb-3">
                        <small>
                            <strong>Danh mục:</strong> {{ detail.indicator.category.name }} | 
                            <strong>Đơn vị đo:</strong> {{ detail.indicator.measurement_unit }} | 
                            <strong>Mục tiêu:</strong> {{ detail.indicator.target_value }} | 
                            <strong>Điểm tối đa:</strong> {{ detail.indicator.max_score }}
                        </small>
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="actual_value_{{ detail.id }}" class="form-label">
                                <strong>Giá trị thực tế đạt được *</strong>
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="actual_value_{{ detail.id }}" 
                                   name="actual_value_{{ detail.id }}" 
                                   step="0.01"
                                   value="{{ detail.actual_value or 0 }}"
                                   required>
                        </div>
                        <div class="col-md-12">
                            <label for="self_assessment_{{ detail.id }}" class="form-label">
                                <strong>Tự đánh giá (tùy chọn)</strong>
                            </label>
                            <textarea class="form-control" 
                                      id="self_assessment_{{ detail.id }}" 
                                      name="self_assessment_{{ detail.id }}" 
                                      rows="2"
                                      placeholder="Mô tả chi tiết về kết quả đạt được...">{{ detail.self_assessment or '' }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Chưa có chỉ số KPI nào.</p>
            {% endif %}
        </div>
    </div>

    <div class="mb-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save"></i> Lưu và Nộp đánh giá
        </button>
        <a href="{{ url_for('evaluation.detail', id=evaluation.id) }}" class="btn btn-secondary btn-lg">
            <i class="bi bi-x-circle"></i> Hủy
        </a>
    </div>
</form>

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> 
    <strong>Lưu ý:</strong> Điểm số sẽ được tự động tính toán dựa trên tỷ lệ giữa giá trị thực tế và giá trị mục tiêu.
    Khi bạn lưu và nộp đánh giá, trạng thái sẽ chuyển sang "Đã nộp" và chờ quản lý phê duyệt.
</div>
{% endblock %}
